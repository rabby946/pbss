{% extends 'student/base.html' %}
{% block title %}Attendance - {{ student.name }}{% endblock %}

{% block head_extra %}
<style>
    /* Color Variables */
    .present { color: #1e8e3e; }
    .absent { color: #d93025; }
    .late { color: #f9ab00; }
    
    .present-bg { background: #e6f4ea; }
    .absent-bg { background: #fce8e6; }
    .late-bg { background: #fef7e0; }

    /* Student Info Banner */
    .student-banner {
        background: linear-gradient(135deg, var(--primary) 0%, #1557b0 100%);
        border-radius: 8px;
        padding: 24px;
        color: white;
        margin-bottom: 24px;
    }

    .student-banner-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .student-avatar {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 600;
        flex-shrink: 0;
    }

    .student-details h1 {
        font-size: 20px;
        font-weight: 500;
        margin: 0 0 8px 0;
    }

    .student-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 13px;
        opacity: 0.9;
    }

    .student-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Status Card */
    .status-section {
        margin-bottom: 16px;
    }

    .status-content {
        text-align: center;
        padding: 32px 16px;
    }

    .date-label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--primary);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 24px;
    }

    .status-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 24px;
        border-radius: 8px;
        max-width: 280px;
        margin: 0 auto;
    }

    .status-icon-circle {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: white;
        font-weight: 700;
    }

    .status-display.present .status-icon-circle { background: #1e8e3e; }
    .status-display.absent .status-icon-circle { background: #d93025; }
    .status-display.late .status-icon-circle { background: #f9ab00; }

    .status-display.present { background: #e6f4ea; }
    .status-display.absent { background: #fce8e6; }
    .status-display.late { background: #fef7e0; }

    .status-label {
        font-size: 18px;
        font-weight: 500;
        text-transform: capitalize;
    }

    .status-display.present .status-label { color: #1e8e3e; }
    .status-display.absent .status-label { color: #d93025; }
    .status-display.late .status-label { color: #f9ab00; }

    .no-status {
        text-align: center;
        padding: 32px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 2px dashed var(--border);
    }

    .no-status i {
        font-size: 48px;
        color: var(--text-tertiary);
        margin-bottom: 12px;
    }

    .no-status p {
        color: var(--text-secondary);
        margin: 0;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .stat-card {
        padding: 20px;
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .stat-items {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 600;
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-item.present .stat-value { color: #1e8e3e; }
    .stat-item.absent .stat-value { color: #d93025; }
    .stat-item.late .stat-value { color: #f9ab00; }

    .stat-label {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 4px;
        text-transform: uppercase;
        font-weight: 500;
    }

    .stat-percent {
        font-size: 12px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
    }

    .stat-item.present .stat-percent {
        background: #e6f4ea;
        color: #1e8e3e;
    }

    .stat-item.absent .stat-percent {
        background: #fce8e6;
        color: #d93025;
    }

    .stat-item.late .stat-percent {
        background: #fef7e0;
        color: #f9ab00;
    }

    /* Calendar */
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
    }

    .calendar-title {
        font-size: 15px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .calendar-nav button {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 14px;
        transition: all 0.2s;
    }

    .calendar-nav button:hover {
        background: var(--bg-hover);
        border-color: var(--text-tertiary);
    }

    .calendar-month {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        min-width: 140px;
        text-align: center;
    }

    .calendar-body {
        padding: 16px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        margin-bottom: 16px;
    }

    .calendar-day-name {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 8px 0;
    }

    .calendar-cell {
        aspect-ratio: 1;
        border: 1px solid var(--border);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .calendar-cell:hover:not(.empty):not(.future) {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
        z-index: 1;
    }

    .calendar-cell.empty {
        background: transparent;
        border-color: transparent;
        cursor: default;
    }

    .calendar-cell.future {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .calendar-cell.today {
        border: 2px solid var(--primary);
        font-weight: 600;
    }

    .calendar-cell.present {
        background: #e6f4ea;
        border-color: #1e8e3e;
        color: #1e8e3e;
    }

    .calendar-cell.absent {
        background: #fce8e6;
        border-color: #d93025;
        color: #d93025;
    }

    .calendar-cell.late {
        background: #fef7e0;
        border-color: #f9ab00;
        color: #f9ab00;
    }

    .cell-day {
        font-size: 14px;
        line-height: 1;
    }

    .cell-status {
        font-size: 9px;
        text-transform: uppercase;
        margin-top: 2px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Legend */
    .calendar-legend {
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .legend-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid;
    }

    .legend-box.present {
        background: #e6f4ea;
        border-color: #1e8e3e;
    }

    .legend-box.absent {
        background: #fce8e6;
        border-color: #d93025;
    }

    .legend-box.late {
        background: #fef7e0;
        border-color: #f9ab00;
    }

    .legend-box.no-data {
        background: white;
        border-color: var(--border);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .student-banner-content {
            flex-direction: column;
            text-align: center;
        }

        .student-meta {
            justify-content: center;
            font-size: 12px;
        }

        .stat-items {
            grid-template-columns: 1fr;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .calendar-nav {
            gap: 8px;
        }

        .calendar-month {
            font-size: 13px;
            min-width: 120px;
        }

        .calendar-cell {
            font-size: 12px;
        }

        .cell-day {
            font-size: 13px;
        }

        .cell-status {
            font-size: 8px;
        }
    }

    @media (max-width: 576px) {
        .student-banner {
            padding: 16px;
        }

        .student-avatar {
            width: 48px;
            height: 48px;
            font-size: 18px;
        }

        .student-details h1 {
            font-size: 18px;
        }

        .calendar-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .calendar-nav {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block student_content %}
<!-- Student Banner -->
<div class="student-banner">
    <div class="student-banner-content">
        <div class="student-avatar">{{ student.name[0]|upper }}</div>
        <div class="student-details">
            <h1>{{ student.name }}</h1>
            <div class="student-meta">
                <span><i class="fas fa-id-card"></i> ID: {{ student.id }}</span>
                <span><i class="fas fa-users"></i> Class: {{ student.class_.name if student.class_ else 'N/A' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Today's Status -->
    <div class="col-lg-4 col-md-12 status-section">
        <div class="card">
            <div class="card-title">Today's Attendance</div>
            <div class="status-content">
                <div class="date-label">
                    <i class="fas fa-calendar"></i>
                    {{ selected_date.strftime('%B %d, %Y') }}
                </div>

                {% set record = attendance_dict.get(student.id) if attendance_dict else None %}
                {% if record %}
                    <div class="status-display {{ record.lower() }}">
                        <div class="status-icon-circle">
                            {% if record == 'present' %}✓
                            {% elif record == 'absent' %}✕
                            {% else %}⏰{% endif %}
                        </div>
                        <div class="status-label">{{ record }}</div>
                    </div>
                {% else %}
                    <div class="no-status">
                        <i class="fas fa-info-circle"></i>
                        <p>No attendance record for this date</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats & Calendar -->
    <div class="col-lg-8 col-md-12">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="card stat-card">
                <div class="stat-header">
                    <i class="fas fa-calendar-week"></i>
                    This Month
                </div>
                <div class="stat-items">
                    <div class="stat-item present">
                        <div class="stat-value" id="monthPresent">0</div>
                        <div class="stat-label">Present</div>
                        <div class="stat-percent" id="monthPresentPercent">0%</div>
                    </div>
                    <div class="stat-item absent">
                        <div class="stat-value" id="monthAbsent">0</div>
                        <div class="stat-label">Absent</div>
                        <div class="stat-percent" id="monthAbsentPercent">0%</div>
                    </div>
                    <div class="stat-item late">
                        <div class="stat-value" id="monthLate">0</div>
                        <div class="stat-label">Late</div>
                        <div class="stat-percent" id="monthLatePercent">0%</div>
                    </div>
                </div>
            </div>

            <div class="card stat-card">
                <div class="stat-header">
                    <i class="fas fa-chart-line"></i>
                    This Year
                </div>
                <div class="stat-items">
                    <div class="stat-item present">
                        <div class="stat-value" id="yearPresent">0</div>
                        <div class="stat-label">Present</div>
                        <div class="stat-percent" id="yearPresentPercent">0%</div>
                    </div>
                    <div class="stat-item absent">
                        <div class="stat-value" id="yearAbsent">0</div>
                        <div class="stat-label">Absent</div>
                        <div class="stat-percent" id="yearAbsentPercent">0%</div>
                    </div>
                    <div class="stat-item late">
                        <div class="stat-value" id="yearLate">0</div>
                        <div class="stat-label">Late</div>
                        <div class="stat-percent" id="yearLatePercent">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card" style="padding: 0;">
            <div class="calendar-header">
                <div class="calendar-title">
                    <i class="fas fa-calendar-alt"></i>
                    Monthly Overview
                </div>
                <div class="calendar-nav">
                    <button id="prevMonth">←</button>
                    <span class="calendar-month" id="currentMonth"></span>
                    <button id="nextMonth">→</button>
                </div>
            </div>
            <div class="calendar-body">
                <div class="calendar-grid" id="calendar"></div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-box present"></span>
                        <span>Present</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-box absent"></span>
                        <span>Absent</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-box late"></span>
                        <span>Late</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-box no-data"></span>
                        <span>No Data</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const attendanceData = {{ all_attendance_records | tojson | safe }};
    const attendanceDict = {};
    attendanceData.forEach(record => {
        attendanceDict[record.date] = record.status;
    });

    let currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('currentMonth').textContent = 
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        calendar.innerHTML = '';

        // Day headers
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-name';
            header.textContent = day;
            calendar.appendChild(header);
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty cells
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-cell empty';
            calendar.appendChild(empty);
        }

        // Days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';

            if (date.getTime() === today.getTime()) {
                cell.classList.add('today');
            }

            if (date > today) {
                cell.classList.add('future');
            }

            const status = attendanceDict[dateStr];
            if (status) {
                cell.classList.add(status.toLowerCase());
                cell.innerHTML = `
                    <div class="cell-day">${day}</div>
                    <div class="cell-status">${status[0]}</div>
                `;
            } else {
                cell.innerHTML = `<div class="cell-day">${day}</div>`;
            }

            if (date <= today) {
                cell.addEventListener('click', () => {
                    window.location.href = `?date=${dateStr}`;
                });
            }

            calendar.appendChild(cell);
        }

        updateMonthlyStats(year, month);
        updateYearlyStats(year);
    }

    function updateStats(prefix, filterFn) {
        let present = 0, absent = 0, late = 0, total = 0;
        
        Object.keys(attendanceDict).forEach(dateStr => {
            if (filterFn(dateStr)) {
                total++;
                const status = attendanceDict[dateStr];
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'late') late++;
            }
        });

        const calcPercent = (val) => total ? Math.round((val / total) * 100) : 0;

        document.getElementById(prefix + 'Present').textContent = present;
        document.getElementById(prefix + 'Absent').textContent = absent;
        document.getElementById(prefix + 'Late').textContent = late;
        document.getElementById(prefix + 'PresentPercent').textContent = calcPercent(present) + '%';
        document.getElementById(prefix + 'AbsentPercent').textContent = calcPercent(absent) + '%';
        document.getElementById(prefix + 'LatePercent').textContent = calcPercent(late) + '%';
    }

    function updateMonthlyStats(year, month) {
        updateStats('month', dateStr => {
            const [y, m] = dateStr.split('-').map(Number);
            return y === year && m === month + 1;
        });
    }

    function updateYearlyStats(year) {
        updateStats('year', dateStr => Number(dateStr.split('-')[0]) === year);
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>
{% endblock %}