{% extends "base.html" %}
{% block title %}Reset Password - Palashbaria Secondary School{% endblock %}

{% block head_extra %}
<style>
    .reset-password-container {
        min-height: calc(100vh - var(--header-height) - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .password-input-wrapper {
        position: relative;
    }
    
    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #9ca3af;
        transition: color 0.2s;
    }
    
    .password-toggle:hover {
        color: #4b5563;
    }
    
    .password-input {
        padding-right: 40px;
    }
    
    .strength-meter {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin-top: 8px;
        overflow: hidden;
    }
    
    .strength-meter-fill {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 2px;
    }
    
    .strength-weak { 
        background: #ef4444; 
        width: 33%;
    }
    
    .strength-medium { 
        background: #f59e0b; 
        width: 66%;
    }
    
    .strength-strong { 
        background: #10b981; 
        width: 100%;
    }
    
    .requirement-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }
    
    .requirement-item.met {
        color: #10b981;
    }
    
    .requirement-item i {
        width: 16px;
        margin-right: 8px;
        font-size: 0.75rem;
    }
    
    .requirement-item.met .fa-circle {
        display: none;
    }
    
    .requirement-item.met .fa-check-circle {
        display: inline;
    }
    
    .requirement-item .fa-check-circle {
        display: none;
    }
    
    .match-indicator {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        margin-top: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.3s;
    }
    
    .match-indicator.hidden {
        display: none;
    }
    
    .match-indicator.match {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
    }
    
    .match-indicator.no-match {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }
    
    .fade-in {
        animation: fadeIn 0.4s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .success-animation {
        animation: successPulse 0.5s ease-out;
    }
    
    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    input.invalid {
        border-color: #ef4444;
    }
    
    input.valid {
        border-color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="reset-password-container">
    <div class="w-full max-w-md">
        <!-- Header Section -->
        <div class="text-center mb-8 fade-in">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                <i class="fas fa-lock text-green-600 text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Reset Password</h2>
            <p class="text-gray-600">Create a strong and secure password for your account</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 fade-in">
            <form method="POST" action="{{ url_for('public.reset_password') }}" id="resetPasswordForm">
                
                <!-- New Password Input -->
                <div class="mb-5">
                    <label for="new_password" class="block text-sm font-semibold text-gray-700 mb-2">
                        New Password
                    </label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            class="password-input w-full px-4 py-3 border border-gray-300 rounded-lg transition-all" 
                            id="new_password" 
                            name="new_password" 
                            placeholder="Enter new password" 
                            required
                            autocomplete="new-password"
                        >
                        <i class="fas fa-eye password-toggle" id="toggleNew" onclick="togglePassword('new_password', 'toggleNew')"></i>
                    </div>
                    
                    <!-- Password Strength Meter -->
                    <div class="strength-meter">
                        <div class="strength-meter-fill" id="strengthMeter"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1" id="strengthText">Password strength</div>
                </div>

                <!-- Password Requirements -->
                <div class="mb-5 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm font-semibold text-gray-700 mb-2">Password must contain:</div>
                    <div id="requirements">
                        <div class="requirement-item" data-requirement="length">
                            <i class="fas fa-circle"></i>
                            <i class="fas fa-check-circle"></i>
                            <span>At least 8 characters</span>
                        </div>
                        <div class="requirement-item" data-requirement="uppercase">
                            <i class="fas fa-circle"></i>
                            <i class="fas fa-check-circle"></i>
                            <span>One uppercase letter (A-Z)</span>
                        </div>
                        <div class="requirement-item" data-requirement="lowercase">
                            <i class="fas fa-circle"></i>
                            <i class="fas fa-check-circle"></i>
                            <span>One lowercase letter (a-z)</span>
                        </div>
                        <div class="requirement-item" data-requirement="number">
                            <i class="fas fa-circle"></i>
                            <i class="fas fa-check-circle"></i>
                            <span>One number (0-9)</span>
                        </div>
                    </div>
                </div>

                <!-- Confirm Password Input -->
                <div class="mb-5">
                    <label for="confirm_password" class="block text-sm font-semibold text-gray-700 mb-2">
                        Confirm Password
                    </label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            class="password-input w-full px-4 py-3 border border-gray-300 rounded-lg transition-all" 
                            id="confirm_password" 
                            name="confirm_password"
                            placeholder="Re-enter your password" 
                            required
                            autocomplete="new-password"
                        >
                        <i class="fas fa-eye password-toggle" id="toggleConfirm" onclick="togglePassword('confirm_password', 'toggleConfirm')"></i>
                    </div>
                    
                    <!-- Match Indicator -->
                    <div class="match-indicator hidden" id="matchIndicator">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span id="matchText">Passwords match</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center"
                    disabled
                >
                    <i class="fas fa-shield-alt mr-2"></i>
                    Reset Password
                </button>
            </form>

            <!-- Security Note -->
            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex">
                    <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-3"></i>
                    <div class="text-sm text-gray-700">
                        <p class="font-medium mb-1">Security Tips</p>
                        <ul class="space-y-1 text-gray-600">
                            <li>• Don't reuse passwords from other accounts</li>
                            <li>• Avoid common words or patterns</li>
                            <li>• Keep your password confidential</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Back Link -->
            <div class="text-center mt-6">
                <a href="{{ url_for('public.login') }}" class="text-sm text-gray-600 hover:text-blue-600 transition-colors inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Login
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submitBtn');
    const strengthMeter = document.getElementById('strengthMeter');
    const strengthText = document.getElementById('strengthText');
    const matchIndicator = document.getElementById('matchIndicator');
    const matchText = document.getElementById('matchText');

    // Password requirements
    const requirements = {
        length: (pass) => pass.length >= 8,
        uppercase: (pass) => /[A-Z]/.test(pass),
        lowercase: (pass) => /[a-z]/.test(pass),
        number: (pass) => /[0-9]/.test(pass)
    };

    // Toggle password visibility
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Check password strength
    function checkPasswordStrength(password) {
        let strength = 0;
        let metRequirements = 0;

        Object.entries(requirements).forEach(([key, checkFn]) => {
            const element = document.querySelector(`[data-requirement="${key}"]`);
            if (checkFn(password)) {
                element.classList.add('met');
                metRequirements++;
            } else {
                element.classList.remove('met');
            }
        });

        // Calculate strength
        if (metRequirements === 4) {
            strength = 3; // Strong
            if (password.length >= 12) strength = 3;
        } else if (metRequirements >= 2) {
            strength = 2; // Medium
        } else if (metRequirements >= 1) {
            strength = 1; // Weak
        }

        return { strength, metRequirements };
    }

    // Update password strength meter
    function updateStrengthMeter(strength) {
        strengthMeter.className = 'strength-meter-fill';
        
        if (strength === 0) {
            strengthMeter.style.width = '0%';
            strengthText.textContent = 'Password strength';
            strengthText.className = 'text-xs text-gray-600 mt-1';
        } else if (strength === 1) {
            strengthMeter.classList.add('strength-weak');
            strengthText.textContent = 'Weak password';
            strengthText.className = 'text-xs text-red-600 mt-1 font-medium';
        } else if (strength === 2) {
            strengthMeter.classList.add('strength-medium');
            strengthText.textContent = 'Medium password';
            strengthText.className = 'text-xs text-orange-600 mt-1 font-medium';
        } else if (strength === 3) {
            strengthMeter.classList.add('strength-strong');
            strengthText.textContent = 'Strong password';
            strengthText.className = 'text-xs text-green-600 mt-1 font-medium';
        }
    }

    // Check if passwords match
    function checkPasswordMatch() {
        const newPass = newPassword.value;
        const confirmPass = confirmPassword.value;

        if (!confirmPass) {
            matchIndicator.classList.add('hidden');
            confirmPassword.classList.remove('valid', 'invalid');
            return false;
        }

        matchIndicator.classList.remove('hidden');

        if (newPass === confirmPass) {
            matchIndicator.className = 'match-indicator match';
            matchText.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Passwords match';
            confirmPassword.classList.remove('invalid');
            confirmPassword.classList.add('valid');
            return true;
        } else {
            matchIndicator.className = 'match-indicator no-match';
            matchText.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Passwords do not match';
            confirmPassword.classList.remove('valid');
            confirmPassword.classList.add('invalid');
            return false;
        }
    }

    // Update submit button state
    function updateSubmitButton() {
        const { metRequirements } = checkPasswordStrength(newPassword.value);
        const passwordsMatch = checkPasswordMatch();
        
        if (metRequirements === 4 && passwordsMatch) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    // Event listeners
    newPassword.addEventListener('input', (e) => {
        const password = e.target.value;
        const { strength, metRequirements } = checkPasswordStrength(password);
        updateStrengthMeter(strength);
        
        if (password) {
            if (metRequirements === 4) {
                newPassword.classList.remove('invalid');
                newPassword.classList.add('valid');
            } else {
                newPassword.classList.remove('valid');
                newPassword.classList.add('invalid');
            }
        } else {
            newPassword.classList.remove('valid', 'invalid');
        }

        updateSubmitButton();
    });

    confirmPassword.addEventListener('input', updateSubmitButton);

    // Form submission
    document.getElementById('resetPasswordForm').addEventListener('submit', (e) => {
        const { metRequirements } = checkPasswordStrength(newPassword.value);
        const passwordsMatch = checkPasswordMatch();

        if (metRequirements !== 4) {
            e.preventDefault();
            alert('Please meet all password requirements');
            return;
        }

        if (!passwordsMatch) {
            e.preventDefault();
            alert('Passwords do not match');
            return;
        }

        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting Password...';
        submitBtn.disabled = true;
    });
</script>
{% endblock %}