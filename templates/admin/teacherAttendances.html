{% extends "admin/base.html" %}
{% block title %}Teacher Attendances{% endblock %}

{% block content %}

<style>
    /* Glass effect */
    .glass-card {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 15px;
        padding: 18px;
        transition: 0.2s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Background tints by status */
    .card-present { background: rgba(210, 255, 210, 0.45) !important; }
    .card-late { background: rgba(255, 245, 185, 0.45) !important; }
    .card-absent { background: rgba(255, 210, 210, 0.45) !important; }
    .card-leave { background: rgba(108, 158, 245, 0.45) !important; }

    .status-badge {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: capitalize;
    }

    .present { background: #d4f8d4; color: #0a7a0a; }
    .absent { background: #ffb8b8; color: #b30000; }
    .late { background: #ffe7c2; color: #b86200; }
    .leave { background: #bad5ff; color: #0039e6; }
    .not-marked { background: #fffefe; color: #555; }

    .time-text { font-weight: bold; font-size: 0.95rem; }

    .teacher-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }

    .action-buttons a { flex: 1; margin: 0 5px; }

    .date-bar {
        background: #ffffffaa;
        backdrop-filter: blur(6px);
        border-radius: 12px;
        padding: 12px 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .search-bar { margin-bottom: 15px; }
</style>

<h3 class="mb-3">Teacher Attendance ({{ selected_date.strftime('%d %b %Y') }})</h3>

<!-- DATE BAR -->
<form method="GET" class="date-bar">
    <label class="fw-bold">Select Date:</label>
    <input type="date" name="date" class="form-control"
           value="{{ selected_date }}" max="{{ today }}">
    <button type="submit" class="btn btn-primary btn-sm">View</button>
</form>

<!-- SEARCH BAR -->
<input type="text" id="searchInput" class="form-control search-bar"
       placeholder="Search teacher by name…">

<!-- CARD GRID -->
<div class="teacher-grid" id="teacherGrid">

    {% for teacher in teachers %}
        {% set att = attendance_dict.get(teacher.id) %}
        {% set status = att.status | lower if att else 'not-marked' %}

        <div class="glass-card card-{{ status }}" data-name="{{ teacher.name | lower }}">
            <h5 class="fw-semibold">{{ teacher.name }}</h5>

            <p class="mt-2">
                <span class="status-badge {{ status }}">{{ att.status if att else 'Not Marked' }}</span>
            </p>

            <div class="mt-3">
                <div>
                    <span class="fw-bold">Check In:</span>
                    {% if att and att.check_in_at %}
                        <span class="time-text">{{ att.check_in_at.strftime('%I:%M %p') }}</span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </div>
                <div>
                    <span class="fw-bold">Check Out:</span>
                    {% if att and att.check_out_at %}
                        <span class="time-text">{{ att.check_out_at.strftime('%I:%M %p') }}</span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex action-buttons mt-3">
                <a href="{{ url_for('admin_bp.teacher_attendance', teacher_id=teacher.id, date=selected_date) }}" 
                   class="btn btn-outline-primary btn-sm">View History</a>

                <a href="{{ url_for('admin_bp.add_leave', teacher_id=teacher.id, date=selected_date) }}" 
                   class="btn btn-outline-secondary btn-sm"
                   onclick="return confirm('Are you sure you want to mark leave for {{ teacher.name }}?');">
                    Mark Leave
                </a>
            </div>
        </div>

    {% endfor %}

</div>
<!-- EXPORT BAR -->
<div class="date-bar mt-3">
    <form method="GET"
          action="{{ url_for('admin_bp.export_teacher_attendance') }}"
          class="d-flex gap-2 align-items-center flex-wrap">

        <label class="fw-bold mb-0">Export Attendance:</label>

        <!-- Month -->
        <select name="month" class="form-select form-select-sm" required>
            <option value="">Select Month</option>
            {% for m in range(1, 13) %}
                <option value="{{ m }}"> {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] }}</option>

            {% endfor %}
        </select>

        <!-- Year -->
        <select name="year" class="form-select form-select-sm" required>
            <option value="">Select Year</option>
            {% for y in range(2024, 2031) %}
                <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn btn-success btn-sm">
            Export Excel
        </button>
    </form>
</div>


<!-- LIVE SEARCH SCRIPT -->
<script>
document.getElementById("searchInput").addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();
    const cards = document.querySelectorAll("#teacherGrid .glass-card");
    cards.forEach(card => {
        const name = card.dataset.name;
        card.style.display = name.includes(query) ? "block" : "none";
    });
});
</script>

{% endblock %}
