{% extends 'student/base.html' %}
{% block title %}Attendance - {{ student.name }}{% endblock %}

{% block head_extra %}
<style>
    :root {
        --present-color: #10b981;
        --absent-color: #ef4444;
        --late-color: #f59e0b;
        --present-bg: #d1fae5;
        --absent-bg: #fee2e2;
        --late-bg: #fef3c7;
        --no-data-bg: #f1f5f9;
        --no-data-border: #e2e8f0;
    }

    /* Student Header Card */
    .student-header-card {
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-indigo));
        padding: 2rem;
        border-radius: 16px;
        color: white;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .student-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        flex-shrink: 0;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .student-header-info h2 {
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.75rem;
    }

    .student-header-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        opacity: 0.95;
        font-size: 0.95rem;
    }

    .student-header-meta span {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Status Display Card */
    .status-card {
        background: var(--bg-primary);
        border-radius: 16px;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-md);
        height: 100%;
    }

    .status-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-secondary);
        border-radius: 16px 16px 0 0;
    }

    .status-card-header h5 {
        margin: 0;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-card-body {
        padding: 2rem 1.5rem;
    }

    .date-display {
        text-align: center;
        margin-bottom: 2rem;
    }

    .date-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-indigo));
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: var(--shadow-md);
    }

    .status-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .status-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        color: white;
        box-shadow: var(--shadow-lg);
    }

    .status-text {
        font-size: 1.5rem;
        font-weight: 700;
        text-transform: capitalize;
    }

    .status-display.status-present {
        background: var(--present-bg);
    }

    .status-display.status-present .status-icon {
        background: var(--present-color);
    }

    .status-display.status-present .status-text {
        color: var(--present-color);
    }

    .status-display.status-absent {
        background: var(--absent-bg);
    }

    .status-display.status-absent .status-icon {
        background: var(--absent-color);
    }

    .status-display.status-absent .status-text {
        color: var(--absent-color);
    }

    .status-display.status-late {
        background: var(--late-bg);
    }

    .status-display.status-late .status-icon {
        background: var(--late-color);
    }

    .status-display.status-late .status-text {
        color: var(--late-color);
    }

    .no-data-alert {
        text-align: center;
        padding: 2rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 2px dashed var(--border-medium);
    }

    .no-data-alert i {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    .no-data-alert p {
        color: var(--text-secondary);
        margin: 0;
        font-size: 1rem;
    }

    /* Stats Cards */
    .stats-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        height: 100%;
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .stats-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .stats-icon {
        font-size: 1.5rem;
    }

    .stats-title {
        font-weight: 600;
        font-size: 1.05rem;
        color: var(--text-primary);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        letter-spacing: 0.05em;
    }

    .stat-percentage {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 50px;
        display: inline-block;
    }

    .present-stat .stat-number {
        color: var(--present-color);
    }

    .present-stat .stat-percentage {
        background: var(--present-bg);
        color: var(--present-color);
    }

    .absent-stat .stat-number {
        color: var(--absent-color);
    }

    .absent-stat .stat-percentage {
        background: var(--absent-bg);
        color: var(--absent-color);
    }

    .late-stat .stat-number {
        color: var(--late-color);
    }

    .late-stat .stat-percentage {
        background: var(--late-bg);
        color: var(--late-color);
    }

    /* Calendar Card */
    .calendar-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .calendar-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-indigo));
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .calendar-card-header h5 {
        margin: 0;
        font-weight: 600;
        color: white;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .calendar-controls button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1rem;
        font-weight: 600;
    }

    .calendar-controls button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    #currentMonth {
        color: white;
        font-weight: 600;
        font-size: 1rem;
        min-width: 150px;
        text-align: center;
    }

    .calendar-card-body {
        padding: 1.5rem;
    }

    .attendance-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 1.5rem;
    }

    .calendar-day-header {
        text-align: center;
        font-weight: 600;
        color: var(--text-secondary);
        padding-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid var(--no-data-border);
        background-color: var(--no-data-bg);
        color: var(--text-secondary);
    }

    .calendar-day:hover:not(.empty):not(.future) {
        transform: scale(1.1);
        box-shadow: var(--shadow-lg);
        z-index: 10;
    }

    .calendar-day.empty {
        background: transparent;
        cursor: default;
        border-color: transparent;
    }

    .calendar-day.future {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .calendar-day.present {
        background: var(--present-bg);
        border-color: var(--present-color);
        color: var(--present-color);
    }

    .calendar-day.absent {
        background: var(--absent-bg);
        border-color: var(--absent-color);
        color: var(--absent-color);
    }

    .calendar-day.late {
        background: var(--late-bg);
        border-color: var(--late-color);
        color: var(--late-color);
    }

    .calendar-day.today {
        border-width: 3px;
        border-color: var(--primary-blue);
        font-weight: 700;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .day-number {
        font-size: 1rem;
        line-height: 1;
    }

    .day-status {
        font-size: 0.65rem;
        text-transform: uppercase;
        margin-top: 4px;
        font-weight: 700;
        letter-spacing: 0.05em;
    }

    /* Legend */
    .legend {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-light);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 5px;
        border: 2px solid;
    }

    .present-color {
        background: var(--present-bg);
        border-color: var(--present-color);
    }

    .absent-color {
        background: var(--absent-bg);
        border-color: var(--absent-color);
    }

    .late-color {
        background: var(--late-bg);
        border-color: var(--late-color);
    }

    .no-data-color {
        background: var(--no-data-bg);
        border-color: var(--no-data-border);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .student-header-card {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
        }

        .student-header-meta {
            justify-content: center;
            font-size: 0.875rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 1.5rem;
        }

        .calendar-controls {
            gap: 0.5rem;
        }

        #currentMonth {
            font-size: 0.875rem;
            min-width: 120px;
        }

        .calendar-day {
            font-size: 0.75rem;
        }

        .day-number {
            font-size: 0.875rem;
        }

        .day-status {
            font-size: 0.6rem;
        }

        .legend {
            gap: 1rem;
        }

        .legend-item {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 576px) {
        .student-avatar-large {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .student-header-info h2 {
            font-size: 1.25rem;
        }

        .calendar-card-header {
            flex-direction: column;
            gap: 1rem;
        }

        .calendar-controls button {
            width: 32px;
            height: 32px;
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block student_content %}
<div class="container-fluid">
    <!-- Student Header -->
    <div class="student-header-card">
        <div class="student-avatar-large">
            <span>{{ student.name[0]|upper }}</span>
        </div>
        <div class="student-header-info">
            <h2>{{ student.name }}</h2>
            <div class="student-header-meta">
                <span><i class="fas fa-id-card"></i> ID: {{ student.id }}</span>
                <span><i class="fas fa-users"></i> Class: {{ student.class_.name if student.class_ else 'N/A' }}</span>
                <span><i class="fas fa-calendar-check"></i> Viewing Attendance</span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Current Status -->
        <div class="col-lg-4">
            <div class="status-card">
                <div class="status-card-header">
                    <h5><i class="fas fa-calendar-day"></i> Today's Attendance</h5>
                </div>
                <div class="status-card-body">
                    <div class="date-display">
                        <div class="date-badge">
                            <i class="fas fa-calendar"></i>
                            {{ selected_date.strftime('%B %d, %Y') }}
                        </div>
                    </div>

                    {% set record = attendance_dict.get(student.id) if attendance_dict else None %}
                    {% if record %}
                        <div class="status-display status-{{ record.lower() }}">
                            <div class="status-icon">
                                {% if record == 'present' %}✓
                                {% elif record == 'absent' %}✕
                                {% else %}⏰{% endif %}
                            </div>
                            <div class="status-text">{{ record }}</div>
                        </div>
                    {% else %}
                        <div class="no-data-alert">
                            <i class="fas fa-info-circle"></i>
                            <p>No attendance record found for this date.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & Calendar -->
        <div class="col-lg-8">
            <!-- Stats Row -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="stats-card">
                        <div class="stats-header">
                            <span class="stats-icon">📅</span>
                            <span class="stats-title">This Month</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item present-stat">
                                <div class="stat-number" id="monthPresent">0</div>
                                <div class="stat-label">Present</div>
                                <div class="stat-percentage" id="monthPresentPercent">0%</div>
                            </div>
                            <div class="stat-item absent-stat">
                                <div class="stat-number" id="monthAbsent">0</div>
                                <div class="stat-label">Absent</div>
                                <div class="stat-percentage" id="monthAbsentPercent">0%</div>
                            </div>
                            <div class="stat-item late-stat">
                                <div class="stat-number" id="monthLate">0</div>
                                <div class="stat-label">Late</div>
                                <div class="stat-percentage" id="monthLatePercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card">
                        <div class="stats-header">
                            <span class="stats-icon">📊</span>
                            <span class="stats-title">This Year</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item present-stat">
                                <div class="stat-number" id="yearPresent">0</div>
                                <div class="stat-label">Present</div>
                                <div class="stat-percentage" id="yearPresentPercent">0%</div>
                            </div>
                            <div class="stat-item absent-stat">
                                <div class="stat-number" id="yearAbsent">0</div>
                                <div class="stat-label">Absent</div>
                                <div class="stat-percentage" id="yearAbsentPercent">0%</div>
                            </div>
                            <div class="stat-item late-stat">
                                <div class="stat-number" id="yearLate">0</div>
                                <div class="stat-label">Late</div>
                                <div class="stat-percentage" id="yearLatePercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Card -->
            <div class="calendar-card">
                <div class="calendar-card-header">
                    <h5><i class="fas fa-calendar-alt"></i> Monthly Overview</h5>
                    <div class="calendar-controls">
                        <button id="prevMonth" aria-label="Previous Month">←</button>
                        <span id="currentMonth"></span>
                        <button id="nextMonth" aria-label="Next Month">→</button>
                    </div>
                </div>
                <div class="calendar-card-body">
                    <div id="calendar" class="attendance-calendar"></div>
                    <div class="legend">
                        <div class="legend-item">
                            <span class="legend-color present-color"></span>
                            <span>Present</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color absent-color"></span>
                            <span>Absent</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color late-color"></span>
                            <span>Late</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color no-data-color"></span>
                            <span>No Data</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Attendance data from Flask
    const attendanceData = {{ all_attendance_records | tojson | safe }};
    const attendanceDict = {};
    attendanceData.forEach(record => {
        attendanceDict[record.date] = record.status;
    });

    let currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('currentMonth').textContent = 
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        calendar.innerHTML = '';

        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            calendar.appendChild(header);
        });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty cells before first day
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendar.appendChild(emptyDay);
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';

            // Mark today
            if (date.getTime() === today.getTime()) {
                dayCell.classList.add('today');
            }

            // Mark future dates
            if (date > today) {
                dayCell.classList.add('future');
            }

            const status = attendanceDict[dateStr];
            if (status) {
                dayCell.classList.add(status.toLowerCase());
                dayCell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-status">${status[0].toUpperCase()}</div>
                `;
            } else {
                dayCell.innerHTML = `<div class="day-number">${day}</div>`;
            }

            // Click handler for past dates
            if (date <= today) {
                dayCell.style.cursor = 'pointer';
                dayCell.addEventListener('click', () => {
                    window.location.href = `?date=${dateStr}`;
                });
            }

            calendar.appendChild(dayCell);
        }

        updateMonthlyStats(year, month);
        updateYearlyStats(year);
    }

    function updateStats(presentEl, absentEl, lateEl, presentPctEl, absentPctEl, latePctEl, filterFn) {
        let present = 0, absent = 0, late = 0, total = 0;
        
        Object.keys(attendanceDict).forEach(dateStr => {
            if (filterFn(dateStr)) {
                total++;
                const status = attendanceDict[dateStr];
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'late') late++;
            }
        });

        const presentPercent = total ? Math.round((present / total) * 100) : 0;
        const absentPercent = total ? Math.round((absent / total) * 100) : 0;
        const latePercent = total ? Math.round((late / total) * 100) : 0;

        document.getElementById(presentEl).textContent = present;
        document.getElementById(absentEl).textContent = absent;
        document.getElementById(lateEl).textContent = late;
        document.getElementById(presentPctEl).textContent = presentPercent + '%';
        document.getElementById(absentPctEl).textContent = absentPercent + '%';
        document.getElementById(latePctEl).textContent = latePercent + '%';
    }

    function updateMonthlyStats(year, month) {
        updateStats(
            'monthPresent', 'monthAbsent', 'monthLate',
            'monthPresentPercent', 'monthAbsentPercent', 'monthLatePercent',
            dateStr => {
                const [y, m] = dateStr.split('-').map(Number);
                return y === year && m === month + 1;
            }
        );
    }

    function updateYearlyStats(year) {
        updateStats(
            'yearPresent', 'yearAbsent', 'yearLate',
            'yearPresentPercent', 'yearAbsentPercent', 'yearLatePercent',
            dateStr => Number(dateStr.split('-')[0]) === year
        );
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>
{% endblock %}