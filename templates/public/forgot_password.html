{% extends "base.html" %}
{% block title %}Forgot Password - Palashbaria Secondary School{% endblock %}

{% block head_extra %}
<style>
    .forgot-password-container {
        min-height: calc(100vh - var(--header-height) - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .search-dropdown {
        max-height: 240px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .search-dropdown::-webkit-scrollbar {
        width: 6px;
    }
    
    .search-dropdown::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .search-dropdown::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .search-dropdown::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    .user-option {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .user-option:last-child {
        border-bottom: none;
    }
    
    .user-option:hover {
        background-color: #f8fafc;
    }
    
    .user-option.selected {
        background-color: #eff6ff;
        border-left: 3px solid #3b82f6;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .user-type-btn {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .user-type-btn:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }
    
    .user-type-btn.active {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .user-type-btn i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
        color: #6b7280;
        transition: color 0.3s;
    }
    
    .user-type-btn.active i {
        color: #3b82f6;
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .no-results {
        padding: 2rem;
        text-align: center;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="forgot-password-container">
    <div class="w-full max-w-md">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <i class="fas fa-key text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Forgot Password?</h2>
            <p class="text-gray-600">Select your account to receive an OTP on your registered phone number</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <form method="POST" action="{{ url_for('public.forgot_password') }}" id="forgotPasswordForm">
                
                <!-- User Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select User Type</label>
                    <div class="flex gap-4">
                        <div class="user-type-btn" onclick="selectUserType('student')" id="studentTypeBtn">
                            <i class="fas fa-user-graduate"></i>
                            <span class="block font-medium text-gray-700">Student</span>
                        </div>
                        <div class="user-type-btn" onclick="selectUserType('teacher')" id="teacherTypeBtn">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span class="block font-medium text-gray-700">Teacher</span>
                        </div>
                    </div>
                    <input type="hidden" name="userType" id="userTypeInput" required>
                </div>

                <!-- Student Selection -->
                <div class="mb-6 fade-in" id="studentSelection" style="display: none;">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search & Select Student</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            class="search-input w-full px-4 py-3 border border-gray-300 rounded-lg transition-all"
                            placeholder="Search by name, ID, class, or roll..."
                            id="studentSearch"
                            autocomplete="off"
                        >
                        <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="search-dropdown mt-2 hidden" id="studentDropdown">
                        {% for s in students %}
                        <div class="user-option" 
                             data-id="{{ s.id }}"
                             data-name="{{ s.name }}"
                             data-student-id="{{ s.studentID }}"
                             data-class="{{ s.class_name }}"
                             data-roll="{{ s.roll }}"
                             onclick="selectStudent(this)">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div class="flex-grow">
                                    <div class="font-medium text-gray-900">{{ s.name }}</div>
                                    <div class="text-sm text-gray-500">ID: {{ s.studentID }} • Class: {{ s.class_.name }} • Roll: {{ s.roll }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="studentID" id="studentIDInput">
                    <div id="selectedStudent" class="mt-3 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                                <div>
                                    <div class="font-medium text-gray-900" id="selectedStudentName"></div>
                                    <div class="text-sm text-gray-600" id="selectedStudentInfo"></div>
                                </div>
                            </div>
                            <button type="button" onclick="clearStudentSelection()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Teacher Selection -->
                <div class="mb-6 fade-in" id="teacherSelection" style="display: none;">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search & Select Teacher</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            class="search-input w-full px-4 py-3 border border-gray-300 rounded-lg transition-all"
                            placeholder="Search by name or designation..."
                            id="teacherSearch"
                            autocomplete="off"
                        >
                        <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="search-dropdown mt-2 hidden" id="teacherDropdown">
                        {% for t in teachers %}
                        <div class="user-option"
                             data-id="{{ t.id }}"
                             data-name="{{ t.name }}"
                             data-designation="{{ t.designation }}"
                             onclick="selectTeacher(this)">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-chalkboard-teacher text-green-600"></i>
                                </div>
                                <div class="flex-grow">
                                    <div class="font-medium text-gray-900">{{ t.name }}</div>
                                    <div class="text-sm text-gray-500">{{ t.designation }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="teacher_id" id="teacherIDInput">
                    <div id="selectedTeacher" class="mt-3 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <div>
                                    <div class="font-medium text-gray-900" id="selectedTeacherName"></div>
                                    <div class="text-sm text-gray-600" id="selectedTeacherInfo"></div>
                                </div>
                            </div>
                            <button type="button" onclick="clearTeacherSelection()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center"
                    disabled
                >
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send OTP
                </button>

                <!-- Back to Login -->
                <div class="text-center mt-6">
                    <a href="{{ url_for('public.login') }}" class="text-sm text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-arrow-left mr-1"></i>
                        Back to Login
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let currentUserType = '';

    function selectUserType(type) {
        currentUserType = type;
        document.getElementById('userTypeInput').value = type;
        
        // Update button states
        document.getElementById('studentTypeBtn').classList.toggle('active', type === 'student');
        document.getElementById('teacherTypeBtn').classList.toggle('active', type === 'teacher');
        
        // Show/hide appropriate selection
        document.getElementById('studentSelection').style.display = type === 'student' ? 'block' : 'none';
        document.getElementById('teacherSelection').style.display = type === 'teacher' ? 'block' : 'none';
        
        // Clear previous selections
        clearStudentSelection();
        clearTeacherSelection();
        
        // Update submit button
        updateSubmitButton();
    }

    // Student search functionality
    const studentSearch = document.getElementById('studentSearch');
    const studentDropdown = document.getElementById('studentDropdown');
    const studentOptions = studentDropdown.querySelectorAll('.user-option');

    studentSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let hasResults = false;
        
        studentOptions.forEach(option => {
            const name = option.dataset.name.toLowerCase();
            const studentId = option.dataset.studentId.toLowerCase();
            const className = option.dataset.class.toLowerCase();
            const roll = option.dataset.roll.toLowerCase();
            
            if (name.includes(searchTerm) || studentId.includes(searchTerm) || 
                className.includes(searchTerm) || roll.includes(searchTerm)) {
                option.style.display = 'block';
                hasResults = true;
            } else {
                option.style.display = 'none';
            }
        });
        
        if (searchTerm.length > 0) {
            studentDropdown.classList.remove('hidden');
        } else {
            studentDropdown.classList.add('hidden');
        }
        
        // Show no results message if needed
        if (!hasResults && searchTerm.length > 0) {
            let noResultsDiv = studentDropdown.querySelector('.no-results');
            if (!noResultsDiv) {
                noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = '<i class="fas fa-search text-3xl mb-2 text-gray-300"></i><p>No students found</p>';
                studentDropdown.appendChild(noResultsDiv);
            }
            noResultsDiv.style.display = 'block';
        } else {
            const noResultsDiv = studentDropdown.querySelector('.no-results');
            if (noResultsDiv) noResultsDiv.style.display = 'none';
        }
    });

    // Teacher search functionality
    const teacherSearch = document.getElementById('teacherSearch');
    const teacherDropdown = document.getElementById('teacherDropdown');
    const teacherOptions = teacherDropdown.querySelectorAll('.user-option');

    teacherSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let hasResults = false;
        
        teacherOptions.forEach(option => {
            const name = option.dataset.name.toLowerCase();
            const designation = option.dataset.designation.toLowerCase();
            
            if (name.includes(searchTerm) || designation.includes(searchTerm)) {
                option.style.display = 'block';
                hasResults = true;
            } else {
                option.style.display = 'none';
            }
        });
        
        if (searchTerm.length > 0) {
            teacherDropdown.classList.remove('hidden');
        } else {
            teacherDropdown.classList.add('hidden');
        }
        
        // Show no results message if needed
        if (!hasResults && searchTerm.length > 0) {
            let noResultsDiv = teacherDropdown.querySelector('.no-results');
            if (!noResultsDiv) {
                noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = '<i class="fas fa-search text-3xl mb-2 text-gray-300"></i><p>No teachers found</p>';
                teacherDropdown.appendChild(noResultsDiv);
            }
            noResultsDiv.style.display = 'block';
        } else {
            const noResultsDiv = teacherDropdown.querySelector('.no-results');
            if (noResultsDiv) noResultsDiv.style.display = 'none';
        }
    });

    function selectStudent(element) {
        const id = element.dataset.id;
        const name = element.dataset.name;
        const studentId = element.dataset.studentId;
        const className = element.dataset.class;
        const roll = element.dataset.roll;
        
        document.getElementById('studentIDInput').value = id;
        document.getElementById('selectedStudentName').textContent = name;
        document.getElementById('selectedStudentInfo').textContent = `ID: ${studentId} • Class: ${className} • Roll: ${roll}`;
        document.getElementById('selectedStudent').classList.remove('hidden');
        document.getElementById('studentDropdown').classList.add('hidden');
        studentSearch.value = '';
        
        updateSubmitButton();
    }

    function selectTeacher(element) {
        const id = element.dataset.id;
        const name = element.dataset.name;
        const designation = element.dataset.designation;
        
        document.getElementById('teacherIDInput').value = id;
        document.getElementById('selectedTeacherName').textContent = name;
        document.getElementById('selectedTeacherInfo').textContent = designation;
        document.getElementById('selectedTeacher').classList.remove('hidden');
        document.getElementById('teacherDropdown').classList.add('hidden');
        teacherSearch.value = '';
        
        updateSubmitButton();
    }

    function clearStudentSelection() {
        document.getElementById('studentIDInput').value = '';
        document.getElementById('selectedStudent').classList.add('hidden');
        studentSearch.value = '';
        studentDropdown.classList.add('hidden');
        updateSubmitButton();
    }

    function clearTeacherSelection() {
        document.getElementById('teacherIDInput').value = '';
        document.getElementById('selectedTeacher').classList.add('hidden');
        teacherSearch.value = '';
        teacherDropdown.classList.add('hidden');
        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const userType = document.getElementById('userTypeInput').value;
        const studentId = document.getElementById('studentIDInput').value;
        const teacherId = document.getElementById('teacherIDInput').value;
        
        if (userType && ((userType === 'student' && studentId) || (userType === 'teacher' && teacherId))) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('#studentSelection')) {
            studentDropdown.classList.add('hidden');
        }
        if (!event.target.closest('#teacherSelection')) {
            teacherDropdown.classList.add('hidden');
        }
    });
</script>
{% endblock %}